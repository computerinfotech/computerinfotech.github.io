<?php ?>
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ONLINE PAYMENT MODE</title>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<style>
body{
    background:#fff8dc;
    font-family:Arial, Helvetica, sans-serif;
    font-weight:bold;
    text-transform:uppercase;
    margin:0;
    padding:0;
    overflow:hidden;
}
.header{text-align:center;margin:5px 0;}
.header img{height:110px;}
.table-box{
    width:90%;
    margin:10px auto;
    background:#ffffcc;
    padding:10px;
    border-radius:6px;
    box-shadow:0 0 6px #999;
}
table{width:100%;border-collapse:collapse;}
th{border:1px solid #333;padding:6px;background:#e6f0ff;color:#003399;}
td{padding:8px;}
input{
    width:90%;
    padding:8px;
    font-size:18px;
    font-weight:bold;
    text-align:center;
    border:2px solid #333;
}
#qrCell{display:flex;flex-direction:column;align-items:center;}
#timer{margin-top:6px;font-size:16px;color:#c40000;}

button{
    padding:8px 18px;
    margin:6px;
    font-size:14px;
    font-weight:bold;
    border:none;
    border-radius:4px;
    cursor:pointer;
}
.successBtn{background:#28a745;color:#fff;}
.newBtn{background:#4a90e2;color:#fff;}
.totalBtn{background:#ff9800;color:#000;}
.pinBtn{background:#6a1b9a;color:#fff;}
.csvBtn{background:#455a64;color:#fff;}

#successBox{
    display:none;
    text-align:center;
    font-size:22px;
    color:#2e7d32;
    margin-top:12px;
}
#totalBox{
    display:none;
    text-align:left;
    font-size:15px;
    margin-top:10px;
    background:#fff3cd;
    padding:10px;
    border-radius:5px;
}

/* PIN MODAL */
#pinModal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    align-items:center;
    justify-content:center;
}
#pinBox{
    background:#fff;
    padding:25px;
    border-radius:10px;
    width:300px;
    text-align:center;
}
#pinInput{
    width:85%;
    font-size:24px;
    padding:10px;
    text-align:center;
    border:2px solid #bdbdbd;
    border-radius:8px;
    letter-spacing:8px;
}

#pinStatus{font-size:36px;margin-top:8px;display:none;}
.pin-ok{color:#2e7d32;}
.pin-wrong{color:#c62828;}
</style>

<script>
let timerInterval;
let timeLeft=120;

let TOTAL_PIN="1234";
let pinMode="VIEW";
let changeStep=0;

/* ===== LOAD OLD PAYMENTS ===== */
let payments = JSON.parse(localStorage.getItem("online_payments")) || [];

/* ===== SAVE FUNCTION ===== */
function savePayments(){
    localStorage.setItem("online_payments", JSON.stringify(payments));
}

function generateQR(){
    const amount=amountInput.value.trim();
    qrCell.innerHTML="";
    successBox.style.display="none";

    if(amount!=="" && !isNaN(amount)){
        const qrBox=document.createElement("div");
        qrCell.appendChild(qrBox);

        new QRCode(qrBox,{
            text:`upi://pay?pa=8250915598@ibl&pn=PAYMENT&am=${amount}&cu=INR`,
            width:210,height:210
        });

        const t=document.createElement("div");
        t.id="timer";
        t.innerText="TIME LEFT: 02:00";

        const b=document.createElement("button");
        b.className="successBtn";
        b.innerText="PAYMENT SUCCESS";
        b.onclick=paymentSuccess;

        qrCell.append(t,b);
        startTimer();
    }
}

function startTimer(){
    clearInterval(timerInterval);
    timeLeft=120;
    timerInterval=setInterval(()=>{
        timeLeft--;
        timer.innerText="TIME LEFT: "+
        String(Math.floor(timeLeft/60)).padStart(2,'0')+":"+
        String(timeLeft%60).padStart(2,'0');
        if(timeLeft<=0){
            clearInterval(timerInterval);
            qrCell.innerHTML="<div id='timer'>TIME EXPIRED</div>";
        }
    },1000);
}

function paymentSuccess(){
    clearInterval(timerInterval);

    const amt=parseInt(amountInput.value);
    const now=new Date();

    payments.push({
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString(),
        amount: amt
    });

    savePayments();   // âœ… permanent save
    successBox.style.display="block";

    if(totalBox.style.display==="block"){
        showTotals();
    }
}

function newPayment(){
    amountInput.value="";
    qrCell.innerHTML="";
    successBox.style.display="none";
}

/* ===== PIN ===== */
function openPin(mode){
    pinMode=mode;
    changeStep=0;
    pinModal.style.display="flex";
    pinInput.value="";
    pinStatus.style.display="none";
    pinInput.focus();
}

function checkPinAuto(el){
    if(el.value.length===4){
        if(pinMode==="VIEW"){
            if(el.value===TOTAL_PIN){
                pinStatus.innerHTML="âœ”";
                pinStatus.className="pin-ok";
                pinStatus.style.display="block";
                setTimeout(()=>{
                    pinModal.style.display="none";
                    showTotals();
                },500);
            }else{
                wrongPin(el);
            }
        }

        if(pinMode==="CHANGE"){
            if(changeStep===0){
                if(el.value===TOTAL_PIN){
                    changeStep=1;
                    el.value="";
                    pinStatus.innerHTML="âœ”";
                    pinStatus.className="pin-ok";
                    pinStatus.style.display="block";
                    setTimeout(()=>pinStatus.style.display="none",400);
                }else{
                    wrongPin(el);
                }
            }else{
                TOTAL_PIN=el.value;
                pinStatus.innerHTML="âœ”";
                pinStatus.className="pin-ok";
                pinStatus.style.display="block";
                setTimeout(()=>{
                    pinModal.style.display="none";
                    alert("PIN CHANGED SUCCESSFULLY");
                },500);
            }
        }
    }
}

function wrongPin(el){
    pinStatus.innerHTML="âœ–";
    pinStatus.className="pin-wrong";
    pinStatus.style.display="block";
    setTimeout(()=>{
        el.value="";
        pinStatus.style.display="none";
    },500);
}

/* ===== TOTAL ===== */
function showTotals(){
    let dateMap={};
    let grandTotal=0;

    payments.forEach(p=>{
        dateMap[p.date]=(dateMap[p.date]||0)+p.amount;
        grandTotal+=p.amount;
    });

    let html=`<b>GRAND TOTAL: â‚¹ ${grandTotal}</b><br><br>`;
    for(let d in dateMap){
        html+=`ðŸ“… ${d} : â‚¹ ${dateMap[d]}<br>`;
    }

    totalBox.innerHTML=html;
    totalBox.style.display="block";
}

/* ===== CSV ===== */
function downloadCSV(){
    if(payments.length===0){
        alert("NO DATA");
        return;
    }

    let csv="Date,Time,Amount\n";
    payments.forEach(p=>{
        csv+=`${p.date},${p.time},${p.amount}\n`;
    });

    const blob=new Blob([csv],{type:"text/csv"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="online_collection.csv";
    a.click();
    URL.revokeObjectURL(url);
}
</script>

</head>
<body>

<div class="header"><img src="ALC01.png"></div>

<div class="table-box">
<table>
<tr><th>AMOUNT</th><th>QR CODE</th></tr>
<tr>
<td align="center">
<input id="amountInput" placeholder="ENTER AMOUNT" oninput="generateQR()">
</td>
<td id="qrCell"></td>
</tr>
</table>

<div id="successBox">âœ… PAYMENT SUCCESSFUL</div>
<div id="totalBox"></div>

<div style="text-align:center;margin-top:15px;">
<button class="newBtn" onclick="newPayment()">NEW PAYMENT</button>
<button class="totalBtn" onclick="openPin('VIEW')">TOTAL ONLINE PAYMENT</button>
<button class="pinBtn" onclick="openPin('CHANGE')">CHANGE PIN</button>
<button class="csvBtn" onclick="downloadCSV()">DOWNLOAD CSV</button>
</div>
</div>

<div id="pinModal">
<div id="pinBox">
<h3>ENTER PIN</h3>
<input type="password" id="pinInput" maxlength="4"
oninput="checkPinAuto(this)">
<div id="pinStatus"></div>
</div>
</div>

</body>
</html>
